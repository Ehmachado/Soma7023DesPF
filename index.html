<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Somar “Realizado” quando A, B, D e E coincidem — GitHub v1.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS local (na mesma pasta do index.html) -->
  ./xlsx.full.min.js</script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#0b1220; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --accent-2:#3b82f6; --danger:#ef4444; --border:#1f2937;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% 10%, #0b1220 0%, var(--bg) 60%),
                  linear-gradient(180deg, #0a0f1d, var(--bg));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1200px; margin:40px auto; padding:0 20px;}
    .hero{display:grid; gap:14px; margin-bottom:22px;}
    .hero h1{font-size: clamp(20px, 3vw, 28px); margin:0; letter-spacing:.2px}
    .hero p{margin:0; color:var(--muted)}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
      border:1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid var(--border); border-radius:12px; padding:16px;
    }
    .label{font-size:13px; color:var(--muted); margin-bottom:8px}
    .file{
      display:flex; gap:10px; align-items:center; border:1px dashed #2a364a; padding:14px;
      border-radius:10px; background: rgba(255,255,255,.02)
    }
    input[type="file"]{color:var(--muted)}
    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px }
    .btn{
      appearance:none; border:1px solid var(--border); color:#fff; background: linear-gradient(180deg, #1f2937, #111827);
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; letter-spacing:.2px;
      transition: all .15s ease-in-out; box-shadow: 0 2px 0 rgba(0,0,0,.25);
    }
    .btn:hover{ transform: translateY(-1px); border-color:#334155 }
    .btn:active{ transform: translateY(0) scale(.997) }
    .btn.primary{ background: linear-gradient(180deg, #16a34a, #15803d); border-color:#14532d }
    .btn.blue{ background: linear-gradient(180deg, #2563eb, #1d4ed8); border-color:#1e40af }
    .btn.red{ background: linear-gradient(180deg, #ef4444, #dc2626); border-color:#b91c1c }
    .hint{font-size:12px; color:var(--muted)}
    table{ width:100%; border-collapse: collapse; }
    th, td{ border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:14px }
    th{ color:#a5b4fc; background: rgba(59,130,246,.06); position:sticky; top:0; z-index:1 }
    .table-wrap{ max-height:55vh; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    .kpi{display:flex; gap:16px; flex-wrap:wrap; margin-top:8px}
    .tag{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background: rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35); color:#86efac; font-size:12px; font-weight:700;
    }
    textarea{
      width:100%; min-height:160px; resize:vertical; color:#e2e8f0; background:#0b1220;
      border:1px solid var(--border); border-radius:10px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .selectlike{ background:#0b1220; border:1px solid var(--border); border-radius:10px; padding:6px 10px; color:#e5e7eb; }
    .footer-hint{font-size:12px; color:var(--muted); margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Somar “Realizado” quando <b>A, B, D e E</b> coincidem</h1>
      <p>Carregue duas planilhas (mesmo cabeçalho). O app ignora cabeçalhos multi‑linha/mesclados e soma a coluna <b>Realizado</b>.</p>
    </div>

    <div class="panel grid">
      <div class="card">
        <div class="label">Planilha 1</div>
        <div class="file"><input id="file1" type="file" accept=".xlsx,.xls,.csv" /></div>
        <div class="hint">Usa a <b>primeira aba</b> do arquivo.</div>
      </div>

      <div class="card">
        <div class="label">Planilha 2</div>
        <div class="file"><input id="file2" type="file" accept=".xlsx,.xls,.csv" /></div>
        <div class="hint">As duas planilhas devem ter o <b>mesmo esquema</b>.</div>
      </div>

      <div class="card">
        <div class="label">Configurações</div>
        <div class="row">
          <span class="selectlike">Chaves: A + B + D + E</span>
          <span class="selectlike">Somar: “Realizado” (auto, fallback = G)</span>
        </div>
        <div class="actions">
          <button class="btn primary" id="runBtn">Processar</button>
          <button class="btn blue" id="dlCsvBtn" disabled>Baixar CSV</button>
          <button class="btn" id="copyBtn" disabled>Copiar (TSV)</button>
          <button class="btn red" id="clearBtn">Limpar</button>
        </div>
        <div class="kpi" id="kpi"></div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <div class="label">Resultado (Tabela)</div>
        <div class="table-wrap">
          <table id="outTable">
            <thead>
              <tr><th>Col A</th><th>Col B</th><th>Col D</th><th>Col E</th><th>Realizado (Σ)</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="label" style="margin-top:14px">Resultado (TSV para copiar)</div>
        <textarea id="outText" placeholder="Clique em Processar para gerar o resultado."></textarea>
        <div class="footer-hint">TSV (tab) cola direto no Excel/Google Sheets.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Índices das chaves
  const A=0, B=1, D=3, E=4;

  const $ = (sel)=>document.querySelector(sel);
  const file1 = $('#file1'), file2 = $('#file2');
  const btnRun=$('#runBtn'), btnCopy=$('#copyBtn'), btnCsv=$('#dlCsvBtn'), btnClear=$('#clearBtn');
  const outTable=$('#outTable').querySelector('tbody'), outText=$('#outText'), kpi=$('#kpi');

  let lastRows = []; // mantém o resultado para exportar/copiar

  function parseNumber(v){
    if (typeof v==='number') return isFinite(v)?v:0;
    if (v===null || v===undefined) return 0;
    let s = String(v).trim(); if (!s) return 0;
    // pt-BR: "1.234.567,89" -> 1234567.89
    if (s.includes(',') && (!s.includes('.') || s.lastIndexOf(',')>s.lastIndexOf('.'))){ s=s.replace(/\./g,''); s=s.replace(/,/g,'.'); }
    else { s=s.replace(/,/g,''); }
    const n = parseFloat(s);
    return isNaN(n)?0:n;
  }
  const norm = (t)=> String(t??'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();

  function readFirstSheetArrayBuffer(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const data = new Uint8Array(reader.result);
          const wb = XLSX.read(data, {type:'array', raw:false, cellDates:true});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:''}); // AOA = array de arrays
          resolve(aoa);
        }catch(e){ reject(e); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // Detecta a coluna "Realizado" pelas linhas iniciais; se não achar, usa G (6)
  function detectRealizadoCol(aoa){
    const MAX_ROWS = Math.min(aoa.length, 6);
    let bestIdx = -1, bestScore=-1;
    for (let r=0;r<MAX_ROWS;r++){
      const row = aoa[r]||[];
      for (let c=0;c<Math.min(row.length, 120);c++){
        const s = norm(row[c]);
        if (!s) continue;
        let score = 0;
        if (/\b(rlz|rlz\.|realizado|realizacao|realiz)\b/.test(s)) score += 3;
        if (/acum|acumul|mes|media|taxa|%|orc|falta/.test(s)) score -= 1; // geralmente não é a base "realizado"
        if (score>bestScore){ bestScore=score; bestIdx=c; }
      }
    }
    return bestIdx>=0 ? bestIdx : 6; // fallback = G
  }

  // Encontra a primeira linha "com cara de dados": chaves presentes e "Realizado" com número
  function findDataStart(aoa, gIndex){
    const MAX_SCAN = Math.min(aoa.length, 50);
    for (let i=0;i<MAX_SCAN;i++){
      const r = aoa[i]||[];
      const keys = [r[A], r[B], r[D], r[E]].map(x=>String(x??'').trim());
      const keysFilled = keys.some(x=>x!==''); // ao menos alguma chave preenchida
      const g = parseNumber(r[gIndex]);
      const gLooksNumber = !isNaN(g) && (String(r[gIndex]).trim()!=='' || g!==0);
      // Evita linhas que parecem cabeçalho
      const headerish = norm(r.join(' '));
      const looksHeader = /prefixo|depend|carteira|tipo|historico|mes|taxa|media|rlz|realiz|orc|falta|acumulado/.test(headerish);
      if (keysFilled && gLooksNumber && !looksHeader) return i;
    }
    // fallback: se não encontrou, assume 2ª linha
    return (aoa.length>1) ? 1 : 0;
  }

  function keyOf(row){
    const safe = (x)=> (x===undefined || x===null) ? '' : String(x).trim();
    return [safe(row[A]).toUpperCase(), safe(row[B]).toUpperCase(), safe(row[D]).toUpperCase(), safe(row[E]).toUpperCase()].join('¦');
  }

  function aggregateTwo(aoa1, aoa2){
    // Detecta "Realizado" em cada planilha (tolerante a deslocamentos)
    const g1 = detectRealizadoCol(aoa1);
    const g2 = detectRealizadoCol(aoa2);
    const start1 = findDataStart(aoa1, g1);
    const start2 = findDataStart(aoa2, g2);

    const map = new Map();
    let rowsIn=0, rowsUsed=0;

    function ingest(aoa, start, gIndex){
      for (let i=start; i<aoa.length; i++){
        const r = aoa[i] || [];
        rowsIn++;
        const a=r[A], b=r[B], d=r[D], e=r[E];
        const allEmpty = [a,b,d,e,r[gIndex]].every(x => (x===undefined || x===null || String(x).trim?.() === ''));
        if (allEmpty) continue;
        const k = keyOf(r);
        const realized = parseNumber(r[gIndex]);
        if (!map.has(k)) map.set(k, {A:a, B:b, D:d, E:e, Gsum:0});
        map.get(k).Gsum += realized;
        rowsUsed++;
      }
    }
    ingest(aoa1, start1, g1);
    ingest(aoa2, start2, g2);

    const out = Array.from(map.values()).sort((r1,r2)=>{
      return String(r1.A).localeCompare(String(r2.A),'pt-BR') ||
             String(r1.B).localeCompare(String(r2.B),'pt-BR') ||
             String(r1.D).localeCompare(String(r2.D),'pt-BR') ||
             String(r1.E).localeCompare(String(r2.E),'pt-BR');
    });
    return { rows: out, stats:{rowsIn, rowsOut: out.length, rowsUsed, g1, g2, start1, start2} };
  }

  function formatNumberBR(n){ return new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0); }

  function renderTable(rows){
    outTable.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (const r of rows){
      const tr = document.createElement('tr');
      [r.A, r.B, r.D, r.E, formatNumberBR(r.Gsum)].forEach((c)=>{
        const td = document.createElement('td'); td.textContent = (c??''); tr.appendChild(td);
      });
      frag.appendChild(tr);
    }
    outTable.appendChild(frag);
  }

  function toTSV(rows){
    const header = ['Col A','Col B','Col D','Col E','Realizado (Σ)'];
    const lines = [header.join('\t')];
    rows.forEach(r=> lines.push([r.A, r.B, r.D, r.E, String((r.Gsum??0).toFixed(2)).replace('.',',')].join('\t')));
    return lines.join('\n');
  }

  function toCSV(rows, sep=';'){
    const header = ['Col A','Col B','Col D','Col E','Realizado (Σ)'];
    const esc=(v)=>{const s=(v??'').toString(); return /[";\n,]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}
    const lines=[header.join(sep)];
    rows.forEach(r=>{
      const gStr = (r.Gsum??0).toFixed(2).replace('.',',');
      lines.push([esc(r.A),esc(r.B),esc(r.D),esc(r.E),esc(gStr)].join(sep));
    });
    return lines.join('\n');
  }

  function setKPIs(stats, rows){
    const mk=(label,value,color='green')=>{
      const span=document.createElement('span'); span.className='tag';
      span.style.background = color==='blue'?'rgba(59,130,246,.12)':(color==='red'?'rgba(239,68,68,.12)':'rgba(34,197,94,.12)');
      span.style.borderColor= color==='blue'?'rgba(59,130,246,.35)':(color==='red'?'rgba(239,68,68,.35)':'rgba(34,197,94,.35)');
      span.style.color     = color==='blue'?'#bfdbfe'           :(color==='red'?'#fecaca'           :'#86efac');
      span.textContent = `${label}: ${value}`; return span;
    }
    kpi.innerHTML='';
    kpi.appendChild(mk('Linhas lidas', stats.rowsIn, 'blue'));
    kpi.appendChild(mk('Chaves únicas', stats.rowsOut, 'green'));
    const total = rows.reduce((a,b)=>a+(b.Gsum||0),0);
    kpi.appendChild(mk('Σ Realizado', new Intl.NumberFormat('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(total), 'green'));
    kpi.appendChild(mk('Col. “Realizado” Arq.1 (índice)', stats.g1, 'blue'));
    kpi.appendChild(mk('Col. “Realizado” Arq.2 (índice)', stats.g2, 'blue'));
    kpi.appendChild(mk('Início dados Arq.1 (linha)', stats.start1, 'blue'));
    kpi.appendChild(mk('Início dados Arq.2 (linha)', stats.start2, 'blue'));
  }

  btnRun.addEventListener('click', async ()=>{
    try{
      if (!file1.files[0] || !file2.files[0]) return alert('Selecione as duas planilhas.');
      btnRun.disabled=true; btnRun.textContent='Processando...';
      const [aoa1, aoa2] = await Promise.all([readFirstSheetArrayBuffer(file1.files[0]), readFirstSheetArrayBuffer(file2.files[0])]);
      const {rows, stats} = aggregateTwo(aoa1, aoa2);
      lastRows = rows;
      renderTable(rows);
      outText.value = toTSV(rows);
      setKPIs(stats, rows);
      btnCopy.disabled = rows.length===0; btnCsv.disabled = rows.length===0;
    }catch(err){
      console.error(err);
      alert('Erro ao ler/processar. Confira se os arquivos são válidos.');
    }finally{
      btnRun.disabled=false; btnRun.textContent='Processar';
    }
  });

  btnCopy.addEventListener('click', async ()=>{
    outText.select(); outText.setSelectionRange(0, 999999);
    const ok=document.execCommand('copy');
    if(!ok && navigator.clipboard){ await navigator.clipboard.writeText(outText.value); }
    btnCopy.textContent='Copiado!'; setTimeout(()=>btnCopy.textContent='Copiar (TSV)',1200);
  });

  btnCsv.addEventListener('click', ()=>{
    const csv = toCSV(lastRows,';');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='resultado_soma_realizado.csv'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  });

  btnClear.addEventListener('click', ()=>{
    file1.value=''; file2.value='';
    outTable.innerHTML=''; outText.value='';
    btnCopy.disabled = true; btnCsv.disabled = true;
    kpi.innerHTML=''; lastRows=[];
  });
})();
</script>
</body>
</html>
